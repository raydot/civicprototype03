<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OpenAI Cost Dashboard - VoterPrime</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      .header {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
      }

      .header h1 {
        color: #333;
        font-size: 32px;
        margin-bottom: 10px;
      }

      .header p {
        color: #666;
        font-size: 16px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .stat-card h3 {
        color: #666;
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .stat-value {
        font-size: 36px;
        font-weight: 700;
        color: #333;
        margin-bottom: 5px;
      }

      .stat-value.cost {
        color: #667eea;
      }

      .stat-value.calls {
        color: #48bb78;
      }

      .stat-value.tokens {
        color: #ed8936;
      }

      .stat-label {
        color: #999;
        font-size: 13px;
      }

      .alert-banner {
        background: #fed7d7;
        border-left: 4px solid #f56565;
        padding: 15px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
      }

      .alert-banner.show {
        display: block;
      }

      .alert-banner strong {
        color: #c53030;
      }

      .chart-section {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
      }

      .chart-section h2 {
        color: #333;
        font-size: 20px;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #f0f0f0;
      }

      .breakdown-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
      }

      .breakdown-item {
        padding: 15px;
        background: #f7fafc;
        border-radius: 8px;
        border-left: 4px solid #667eea;
      }

      .breakdown-item h4 {
        color: #333;
        font-size: 16px;
        margin-bottom: 8px;
      }

      .breakdown-stats {
        display: flex;
        justify-content: space-between;
        color: #666;
        font-size: 14px;
      }

      .breakdown-stats span {
        font-weight: 600;
        color: #667eea;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .loading::after {
        content: '...';
        animation: dots 1.5s steps(4, end) infinite;
      }

      @keyframes dots {
        0%,
        20% {
          content: '.';
        }
        40% {
          content: '..';
        }
        60%,
        100% {
          content: '...';
        }
      }

      .error {
        background: #fed7d7;
        color: #c53030;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
      }

      .refresh-btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.3s;
      }

      .refresh-btn:hover {
        background: #5568d3;
      }

      .last-updated {
        color: #999;
        font-size: 13px;
        margin-top: 10px;
      }

      .period-selector {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }

      .period-btn {
        padding: 8px 16px;
        border: 2px solid #e2e8f0;
        background: white;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
      }

      .period-btn.active {
        background: #667eea;
        color: white;
        border-color: #667eea;
      }

      .period-btn:hover {
        border-color: #667eea;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üí∞ OpenAI Cost Dashboard</h1>
        <p>Real-time monitoring of API usage and costs</p>
        <div style="margin-top: 15px">
          <button class="refresh-btn" onclick="loadAllData()">
            üîÑ Refresh Data
          </button>
          <span class="last-updated" id="lastUpdated"></span>
        </div>
      </div>

      <div class="alert-banner" id="alertBanner">
        <strong>‚ö†Ô∏è Cost Alert:</strong> <span id="alertMessage"></span>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <h3>Today's Cost</h3>
          <div class="stat-value cost" id="todayCost">$0.00</div>
          <div class="stat-label">Last 24 hours</div>
        </div>
        <div class="stat-card">
          <h3>Total API Calls</h3>
          <div class="stat-value calls" id="todayCalls">0</div>
          <div class="stat-label">Today</div>
        </div>
        <div class="stat-card">
          <h3>Total Tokens</h3>
          <div class="stat-value tokens" id="todayTokens">0</div>
          <div class="stat-label">Processed today</div>
        </div>
        <div class="stat-card">
          <h3>Monthly Projection</h3>
          <div class="stat-value cost" id="monthProjection">$0.00</div>
          <div class="stat-label">Estimated this month</div>
        </div>
      </div>

      <div class="chart-section">
        <h2>üìä Cost Breakdown by Model</h2>
        <div id="modelBreakdown" class="loading">Loading model data</div>
      </div>

      <div class="chart-section">
        <h2>üéØ Cost Breakdown by Endpoint</h2>
        <div id="endpointBreakdown" class="loading">Loading endpoint data</div>
      </div>

      <div class="chart-section">
        <h2>üìà 7-Day Cost Trend</h2>
        <div class="period-selector">
          <button class="period-btn active" onclick="loadTrend(7)">
            7 Days
          </button>
          <button class="period-btn" onclick="loadTrend(30)">30 Days</button>
        </div>
        <div id="trendData" class="loading">Loading trend data</div>
      </div>
    </div>

    <script>
      const API_BASE = window.location.origin
      const ADMIN_TOKEN = 'voterPrime_admin_2024' // TODO: Make this configurable

      async function fetchAPI(endpoint) {
        const response = await fetch(
          `${API_BASE}${endpoint}?token=${ADMIN_TOKEN}`
        )
        if (!response.ok) {
          throw new Error(`API error: ${response.status}`)
        }
        return response.json()
      }

      async function loadTodayStats() {
        try {
          const data = await fetchAPI('/admin/openai-costs/today')

          document.getElementById(
            'todayCost'
          ).textContent = `$${data.total_cost.toFixed(4)}`
          document.getElementById('todayCalls').textContent =
            data.total_calls.toLocaleString()
          document.getElementById('todayTokens').textContent =
            data.total_tokens.toLocaleString()

          // Display model breakdown
          const modelDiv = document.getElementById('modelBreakdown')
          if (data.by_model && data.by_model.length > 0) {
            modelDiv.innerHTML =
              '<div class="breakdown-grid">' +
              data.by_model
                .map(
                  (model) => `
                            <div class="breakdown-item">
                                <h4 style="word-break: break-word;">${
                                  model.model
                                }</h4>
                                <div class="breakdown-stats">
                                    <div>Calls: <span>${
                                      model.call_count
                                    }</span></div>
                                    <div>Cost: <span>$${model.total_cost.toFixed(
                                      4
                                    )}</span></div>
                                </div>
                            </div>
                        `
                )
                .join('') +
              '</div>'
          } else {
            modelDiv.innerHTML =
              '<p style="color: #999; text-align: center;">No data yet</p>'
          }
        } catch (error) {
          console.error('Error loading today stats:', error)
          document.getElementById('todayCost').textContent = 'Error'
        }
      }

      async function loadMonthStats() {
        try {
          const data = await fetchAPI('/admin/openai-costs/month')
          document.getElementById(
            'monthProjection'
          ).textContent = `$${data.projected_monthly_cost.toFixed(2)}`
        } catch (error) {
          console.error('Error loading month stats:', error)
          document.getElementById('monthProjection').textContent = 'Error'
        }
      }

      async function loadEndpointBreakdown() {
        try {
          const data = await fetchAPI(
            '/admin/openai-costs/summary?days=7&group_by=endpoint'
          )
          const endpointDiv = document.getElementById('endpointBreakdown')

          if (data.summary && data.summary.length > 0) {
            endpointDiv.innerHTML =
              '<div class="breakdown-grid">' +
              data.summary
                .slice(0, 6)
                .map(
                  (item) => `
                            <div class="breakdown-item">
                                <h4>${item.endpoint || 'Unknown'}</h4>
                                <div class="breakdown-stats">
                                    <div>Calls: <span>${
                                      item.call_count
                                    }</span></div>
                                    <div>Cost: <span>$${item.total_cost.toFixed(
                                      4
                                    )}</span></div>
                                </div>
                            </div>
                        `
                )
                .join('') +
              '</div>'
          } else {
            endpointDiv.innerHTML =
              '<p style="color: #999; text-align: center;">No data yet</p>'
          }
        } catch (error) {
          console.error('Error loading endpoint breakdown:', error)
          document.getElementById('endpointBreakdown').innerHTML =
            '<div class="error">Error loading endpoint data</div>'
        }
      }

      async function loadTrend(days) {
        try {
          // Update active button
          document
            .querySelectorAll('.period-btn')
            .forEach((btn) => btn.classList.remove('active'))
          event.target.classList.add('active')

          const data = await fetchAPI(
            `/admin/openai-costs/summary?days=${days}&group_by=day`
          )

          const trendDiv = document.getElementById('trendData')

          if (data.summary && data.summary.length > 0) {
            trendDiv.innerHTML =
              '<div class="breakdown-grid">' +
              data.summary
                .slice(0, 10)
                .map(
                  (item) => `
                            <div class="breakdown-item">
                                <h4>${item.date}</h4>
                                <div class="breakdown-stats">
                                    <div>Calls: <span>${
                                      item.call_count
                                    }</span></div>
                                    <div>Cost: <span>$${item.total_cost.toFixed(
                                      4
                                    )}</span></div>
                                </div>
                            </div>
                        `
                )
                .join('') +
              '</div>'
          } else {
            trendDiv.innerHTML =
              '<p style="color: #999; text-align: center;">No data yet</p>'
          }
        } catch (error) {
          console.error('Error loading trend:', error)
          document.getElementById('trendData').innerHTML =
            '<div class="error">Error loading trend data</div>'
        }
      }

      async function checkAlerts() {
        try {
          const data = await fetchAPI('/admin/openai-costs/alerts&threshold=50')

          if (data.alerts && data.alerts.length > 0) {
            const alertBanner = document.getElementById('alertBanner')
            const alertMessage = document.getElementById('alertMessage')
            alertMessage.textContent = data.alerts[0].message
            alertBanner.classList.add('show')
          }
        } catch (error) {
          console.error('Error checking alerts:', error)
        }
      }

      async function loadAllData() {
        const now = new Date().toLocaleString()
        document.getElementById(
          'lastUpdated'
        ).textContent = `Last updated: ${now}`

        await Promise.all([
          loadTodayStats(),
          loadMonthStats(),
          loadEndpointBreakdown(),
          loadTrend(7),
          checkAlerts()
        ])
      }

      // Load data on page load
      loadAllData()

      // Auto-refresh every 60 seconds
      setInterval(loadAllData, 60000)
    </script>
  </body>
</html>
